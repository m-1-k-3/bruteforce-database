name: Quality Assurance

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    name: Validate Wordlists
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Run validation suite
      run: |
        echo "ğŸ” Running wordlist validation..."
        python3 scripts/validate.py

    - name: Check for encoding issues
      run: |
        echo "ğŸ“ Checking file encodings..."
        if file *.txt *.lst 2>/dev/null | grep -v "UTF-8\|ASCII"; then
          echo "âš ï¸  Warning: Non-UTF-8 files detected"
        else
          echo "âœ“ All files are UTF-8 or ASCII"
        fi

    - name: Generate statistics
      run: |
        echo "ğŸ“Š Generating statistics..."
        echo "Total wordlist files: $(find . -type f \( -name "*.txt" -o -name "*.lst" \) ! -path "./.git/*" | wc -l)"
        echo "Total size: $(du -sh . | cut -f1)"
        echo "Total lines: $(find . -type f \( -name "*.txt" -o -name "*.lst" \) ! -path "./.git/*" -exec wc -l {} + | tail -1 | awk '{print $1}')"

    - name: Upload manifest
      uses: actions/upload-artifact@v4
      with:
        name: wordlist-manifest
        path: manifest.json
        retention-days: 30

    - name: Validate manifest
      run: |
        if [ -f manifest.json ]; then
          echo "âœ“ Manifest generated successfully"
          cat manifest.json | python3 -m json.tool > /dev/null
          echo "âœ“ Manifest is valid JSON"
        else
          echo "âœ— Manifest generation failed"
          exit 1
        fi

  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for sensitive data
      run: |
        echo "ğŸ”’ Scanning for potential sensitive data patterns..."

        # Check for API keys, tokens, etc.
        if grep -r -i -E "(api[_-]?key|secret[_-]?key|password|token|bearer)" *.txt *.lst 2>/dev/null | grep -v "password" | head -5; then
          echo "âš ï¸  Warning: Potential sensitive data patterns found"
          echo "âš ï¸  Please review carefully"
        else
          echo "âœ“ No obvious sensitive data patterns detected"
        fi

    - name: Verify file sizes
      run: |
        echo "ğŸ“ Checking for unexpectedly large files..."
        find . -type f \( -name "*.txt" -o -name "*.lst" \) ! -path "./.git/*" -size +100M -exec ls -lh {} \; | while read line; do
          echo "âš ï¸  Large file detected: $line"
        done || echo "âœ“ All files within reasonable size limits"

  integrity:
    name: Integrity Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify file integrity
      run: |
        echo "ğŸ” Verifying file integrity..."

        # Check for null bytes (corruption indicator)
        if find . -type f \( -name "*.txt" -o -name "*.lst" \) ! -path "./.git/*" -exec grep -l $'\x00' {} \; 2>/dev/null | head -5; then
          echo "âœ— Corrupted files detected (null bytes found)"
          exit 1
        else
          echo "âœ“ No corrupted files detected"
        fi

    - name: Check line endings
      run: |
        echo "ğŸ“„ Checking line endings consistency..."
        if find . -type f \( -name "*.txt" -o -name "*.lst" \) ! -path "./.git/*" -exec file {} \; | grep -i "CRLF" | head -5; then
          echo "âš ï¸  Warning: Windows line endings (CRLF) detected"
          echo "âš ï¸  Consider normalizing to Unix (LF) for consistency"
        else
          echo "âœ“ Line endings are consistent"
        fi
